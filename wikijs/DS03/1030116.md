## Basic Information
| Key         | Value          |
|-------------|----------------|
| Table       | DS03 Cost |
| Severity    | ERROR |
| Unique ID   | 1030116   |
| Summary     | Is indirect distributed inconsistently? |
| Error message | Possible Reasons: 1) indirect actuals found where is_indirect = Y, and both EOC = Indirect and EOC <> Indirect are used; 2) is_indirect utilized in some WPs/CAs and missing in others; 3) indirect actuals found at both the CA & WP levels; 4) data found where is_indirect = N but EOC = Indirect. |

## What causes this error?

> :robot: The following text was generated by an AI tool and hasn't been reviewed for accuracy by a human! It might be useful, but it also might have errors. Are you a human? You can help by reviewing it for accuracy! Edit it as needed then remove this message.
{.is-warning}

This Data Integrity and Quality (DIQ) check focuses on the consistency of indirect cost reporting within the DS03 Cost table. The purpose of this check is to ensure that indirect costs are accurately and consistently categorized across different levels of work breakdown structure (WBS) elements, such as Control Accounts (CAs) and Work Packages (WPs). The check identifies several potential inconsistencies:

1. **Inconsistent Use of Indirect Flag and Element of Cost (EOC) Designation**: This issue arises when the 'is_indirect' flag is set to 'Y' (indicating an indirect cost), but the EOC field contains both 'Indirect' and other values within the same WBS elements. This inconsistency can lead to misclassification of costs.

2. **Inconsistent Application of the Indirect Flag Across WPs/CAs**: This occurs when some WPs or CAs have the 'is_indirect' flag applied (either as 'Y' or 'N'), while others do not have the flag set at all. Consistent application of the 'is_indirect' flag is crucial for accurate cost reporting and analysis.

3. **Indirect Costs Reported at Both CA and WP Levels**: Indirect costs should typically be reported consistently at a specific level of the WBS. Finding indirect costs at both the CA and WP levels may indicate a breakdown in the cost reporting structure or misunderstanding of cost allocation practices.

4. **Incorrect Use of Indirect Flag with EOC**: Situations where the 'is_indirect' flag is set to 'N' (indicating a direct cost) but the EOC is labeled as 'Indirect' suggest a misalignment between the cost type and its classification. This misalignment can affect cost analysis and reporting accuracy.

5. **Duplication of Indirect EOC at Different Levels**: Identifying 'Indirect' EOC at both CA and WP levels, especially when actual costs are associated, may indicate duplication or incorrect allocation of indirect costs.

The fields primarily involved in these inconsistencies are 'WBS_ID_CA', 'WBS_ID_WP', 'is_indirect', and 'EOC'. Expected values for these fields should align with the project's cost reporting structure: 'is_indirect' should be consistently applied and accurately reflect the nature of the cost (Y for indirect, N for direct), and 'EOC' should match the 'is_indirect' designation. Correcting these inconsistencies involves reviewing and adjusting the cost categorization practices to ensure that indirect costs are accurately and consistently reported across all levels of the project's WBS.
## Why do we check this?

> :robot: The following text was generated by an AI tool and hasn't been reviewed for accuracy by a human! It might be useful, but it also might have errors. Are you a human? You can help by reviewing it for accuracy! Edit it as needed then remove this message.
{.is-warning}

This test, titled "Inconsistent Use of Indirect," is being performed on the "DS03 Cost" table to ensure that the handling of indirect costs within the project management data is consistent and accurate. The severity of this test is marked as ERROR, indicating that any issues found must be addressed immediately as they could significantly impact the ability to review and analyze the data correctly.

The importance of this check lies in ensuring that indirect costs are correctly categorized and consistently applied across all work packages (WPs) and control accounts (CAs). Indirect costs, unlike direct costs, are not directly tied to a specific project activity but are necessary for the overall operation of the project (such as utilities, administrative expenses, etc.). Proper classification and consistent application are crucial for accurate cost tracking, budgeting, and financial reporting.

The test looks for several potential issues:
1. The presence of indirect actuals in entries marked as indirect (is_indirect = Y) where the Element of Cost (EOC) is inconsistently labeled as both "Indirect" and not "Indirect."
2. The inconsistent use of the is_indirect flag across different WPs/CAs, with it being utilized in some instances and missing in others.
3. The finding of indirect actuals at both the CA and WP levels, which could indicate double counting or misallocation of costs.
4. Data entries marked as not indirect (is_indirect = N) but having an EOC labeled as "Indirect," suggesting a misclassification.

Addressing these issues is critical to maintaining the integrity of the project's financial data. Inaccurate or inconsistent handling of indirect costs can lead to misreported financials, impact project budgeting and forecasting, and potentially lead to non-compliance with financial reporting standards or regulations. Correcting these errors ensures that the project's financial data accurately reflects its true cost structure, enabling better decision-making and compliance with financial standards.
## Code

```sql

CREATE FUNCTION [dbo].[fnDIQ_DS03_Cost_IsIndirectUseInconsistent] (
	@upload_id int = 0
)
RETURNS TABLE
AS RETURN
(
	with Cost as (
		SELECT WBS_ID_CA CA, ISNULL(WBS_ID_WP,'') WP, ISNULL(is_indirect,'') IsInd, EOC, CASE WHEN ACWPi_Dollars > 0 OR ACWPi_hours > 0 OR ACWPi_FTEs > 0 THEN 1 ELSE 0 END HasA
		FROM DS03_cost
		WHERE upload_ID = @upload_id
	)
	SELECT *
	FROM DummyRow_Get(@upload_ID)
	WHERE  	( --WP Indirect Actuals where IsInd = Y, and where both EOC = Indirect and EOC <> Indirect are used.
			EXISTS (SELECT 1 FROM Cost WHERE WP <> '' AND IsInd = 'Y' AND EOC = 'Indirect' AND HasA = 1) 
		AND EXISTS (SELECT 1 FROM Cost WHERE WP <> '' AND IsInd = 'Y' AND EOC <> 'Indirect' AND HasA = 1)
	) OR (	--WP actuals where IsInd is utilized and where it is not (i.e. if it is used, it must be used everywhere, and vice versa)
			EXISTS (SELECT 1 FROM Cost WHERE WP <> '' AND IsInd = '' AND HasA = 1) 
		AND EXISTS (SELECT 1 FROM Cost WHERE WP <> '' AND IsInd <> '' AND HasA = 1) 
	) OR ( 	--CA Indirect Actuals collected where EOC = Indirect AND IsInd = Y, while WP Indirect Actuals collected where EOC <> Indirect AND IsInd = Y
			EXISTS (SELECT 1 FROM Cost WHERE WP = '' AND IsInd = 'Y' AND EOC = 'Indirect' AND HasA = 1)
		AND EXISTS (SELECT 1 FROM Cost WHERE WP <> '' AND IsInd = 'Y' AND EOC <> 'Indirect' AND HasA = 1)
	) OR (
			EXISTS (SELECT 1 FROM Cost WHERE WP = '' AND IsInd = 'Y' AND EOC = 'Indirect' AND HasA = 1)
		AND EXISTS (SELECT 1 FROM Cost WHERE WP = '' AND IsInd = 'Y' AND EOC = 'Indirect' AND HasA = 0)
	) OR (	--WP/CAs where IsInd = N & EOC = Indirect (bit of an outlier, but still needed for quality)
			EXISTS (SELECT 1 FROM Cost WHERE IsInd = 'N' AND EOC = 'Indirect')
	) OR ( -- EOC = Indirect at both CA & WP levels
			EXISTS (SELECT 1 FROM Cost WHERE WP = '' AND EOC = 'Indirect' AND HasA = 1)
		AND EXISTS (SELECT 1 FROM Cost WHERE WP <> '' AND EOC = 'Indirect' AND HasA = 1)
	) OR (	--Scenario F.a and any other scenario
			EXISTS (SELECT 1 FROM Cost WHERE CA = WP)
		AND EXISTS (SELECT 1 FROM Cost WHERE CA <> WP)
	) OR ( -- Also scenario F.a and any other scenario
			EXISTS (SELECT 1 FROM Cost WHERE WP <> '' AND IsInd = 'Y' AND EOC = 'Indirect' AND HasA = 1)
		AND EXISTS (SELECT 1 FROM Cost WHERE WP <> '' AND IsInd = 'Y' AND EOC <> 'Indirect' AND HasA = 1)
	)
)
```
