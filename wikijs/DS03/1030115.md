## Basic Information
| Key         | Value          |
|-------------|----------------|
| Table       | DS03 Cost |
| Severity    | MAJOR |
| Unique ID   | 1030115   |
| Summary     | Is indirect collected at the CA level or via the EOC field (rather than using is_indirect)? |
| Error message | EOC = Indirect, is_indirect missing, or is_indirect = Y/N found at the CA level (where WBS_ID_WP is blank). |

## What causes this error?

> :robot: The following text was generated by an AI tool and hasn't been reviewed for accuracy by a human! It might be useful, but it also might have errors. Are you a human? You can help by reviewing it for accuracy! Edit it as needed then remove this message.
{.is-warning}

This Data Integrity and Quality (DIQ) check is designed to ensure the proper collection of indirect costs within the DS03 Cost table. Indirect costs should be accurately identified to maintain the integrity of project cost management. The check identifies three potential issues with how indirect costs are recorded:

1. **Indirect Costs Not Flagged**: The first issue arises when the `is_indirect` field is not utilized. This field is essential for correctly identifying costs as indirect. When this field is left null, it indicates that the record may not have been properly reviewed or classified, leading to inaccuracies in cost reporting and analysis.

2. **Incorrect Use of `is_indirect` at the Control Account (CA) Level**: The second issue is detected when the `is_indirect` field is filled at the CA level, where the Work Breakdown Structure ID for Work Packages (`WBS_ID_WP`) is blank. Indirect costs should be collected and flagged at the appropriate level, and filling out the `is_indirect` field at the CA level, instead of at more granular levels, can lead to misrepresentation of how costs are allocated across the project.

3. **Misuse of the Element of Cost (EOC) Field**: The third issue occurs when indirect costs are incorrectly entered in the `EOC` field as 'Indirect'. While the `EOC` field is crucial for categorizing costs, the proper method for indicating indirect costs is through the `is_indirect` field. Using the `EOC` field for this purpose can cause confusion and inaccuracies in cost categorization and reporting.

To address these issues, it is recommended to review and correct the records by ensuring that the `is_indirect` field is appropriately used to flag indirect costs, especially ensuring it is not misused at the CA level where `WBS_ID_WP` is blank. Additionally, the `EOC` field should not be used as a substitute for the `is_indirect` field. Proper classification and flagging of indirect costs are crucial for accurate cost management and reporting in project management.
## Why do we check this?

> :robot: The following text was generated by an AI tool and hasn't been reviewed for accuracy by a human! It might be useful, but it also might have errors. Are you a human? You can help by reviewing it for accuracy! Edit it as needed then remove this message.
{.is-warning}

This DIQ test, titled "Improper Collection of Indirect," is being performed on the "DS03 Cost" table to ensure that indirect costs are being collected and categorized correctly within the project management data. The test is checking if the indirect costs are being collected at the Control Account (CA) level or via the Element of Cost (EOC) field, rather than appropriately using the "is_indirect" field to flag these costs. The presence of an "EOC = Indirect," "is_indirect missing," or "is_indirect = Y/N found at the CA level (where WBS_ID_WP is blank)" triggers a warning.

The importance of this check lies in ensuring that indirect costs are accurately identified and segregated from direct costs. Accurate categorization is crucial for proper cost management and reporting, as it affects the project's financial analysis, cost control, and the allocation of indirect costs across various work packages or activities. Misclassification can lead to incorrect financial reporting and analysis, potentially affecting decision-making and the overall financial health of the project.

The severity level of "MAJOR" indicates that while the issue might not immediately invalidate the data review process, it is likely to cause problems during data analysis or financial reporting. It suggests that corrective action should be taken to ensure that indirect costs are correctly flagged and collected, adhering to best practices and maintaining the integrity and quality of the project management data.
## Code

```sql

CREATE FUNCTION [dbo].[fnDIQ_DS03_Cost_IsIndirectCollectedImproperly] (
	@upload_id int = 0
)
RETURNS TABLE
AS RETURN
(
	SELECT *
	FROM DummyRow_Get(@upload_ID)
	WHERE EXISTS (
		SELECT * 
		FROM DS03_cost
		WHERE upload_ID = @upload_id
			AND (
					is_indirect IS NULL  --is_indirect is unused
				OR (TRIM(ISNULL(WBS_ID_WP,'')) = '' AND ISNULL(is_indirect,'') <> '') --CA data with is_indirect
				OR EOC = 'Indirect' --indirect in the EOC column
			)
	)
)
```
