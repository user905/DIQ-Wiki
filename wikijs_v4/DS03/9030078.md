## Basic Information
| Key         | Value          |
|-------------|----------------|
| Table       | DS03 Cost |
| Severity    | ERROR |
| Unique ID   | 9030078   |
| Summary     | Is the WBS ID to which this work is apportioned mismatched in cost and schedule? |
| Error message | EVT = J or M where EVT_J_to_WBS_ID does not equal the WBS ID in Schedule. |

## What causes this error?

> :robot: The following text was generated by an AI tool and hasn't been reviewed for accuracy by a human! It might be useful, but it also might have errors. Are you a human? You can help by reviewing it for accuracy! Edit it as needed then remove this message.
{.is-warning}

The Data Integrity and Quality (DIQ) check titled "Apportionment IDs Mismatch Between Cost and Schedule" is designed to identify any discrepancies between the Work Breakdown Structure (WBS) ID in the DS03 Cost table and the DS04 Schedule table. 

This check is particularly important when the Event Type (EVT) is either 'J' or 'M'. In these cases, the WBS ID to which the work is apportioned (EVT_J_to_WBS_ID) should match the WBS ID in the Schedule table. If there is a mismatch, it indicates a potential data integrity issue.

The error is likely to be caused by incorrect data entry or data transfer between the Cost and Schedule tables. The fields causing the issue are the EVT, EVT_J_to_WBS_ID in the Cost table and the WBS_ID in the Schedule table. 

The expected values for the EVT field are 'J' or 'M'. The EVT_J_to_WBS_ID in the Cost table should match the WBS_ID in the Schedule table. If the WBS ID is NULL in the Schedule table, it means that the task is not apportioned to anything, which could also trigger this DIQ check. 

To resolve this issue, ensure that the WBS IDs match between the Cost and Schedule tables for all tasks with EVT 'J' or 'M'. If a task is not apportioned to anything, the WBS ID should be NULL in both tables.
## Why do we check this?

> :robot: The following text was generated by an AI tool and hasn't been reviewed for accuracy by a human! It might be useful, but it also might have errors. Are you a human? You can help by reviewing it for accuracy! Edit it as needed then remove this message.
{.is-warning}

This test is being performed to ensure that the Work Breakdown Structure (WBS) ID, to which the work is apportioned, is consistent between the cost and schedule data. The test checks if the Earned Value Technique (EVT) is either J or M, and if so, it verifies that the WBS ID associated with this EVT matches the WBS ID in the schedule data.

The importance of this check lies in maintaining data integrity and ensuring accurate project management. The WBS ID is a critical element in project management as it helps in organizing, defining, and planning the work scope of the project. If there is a mismatch between the WBS IDs in the cost and schedule data, it could lead to incorrect project tracking, budgeting, and scheduling, which could ultimately impact the successful completion of the project.

The severity of this test is marked as 'ERROR', which is the highest level of severity. This means that if there is a mismatch, it is a critical issue that must be fixed immediately. If not corrected, the data cannot be reviewed or used for further analysis, which could significantly hinder project management and decision-making processes.
## Code

```sql

CREATE FUNCTION [dbo].[fnDIQ_DS03_Cost_IsApportionedWBSIDMismatchedWithDS04] (
	@upload_id int = 0
)
RETURNS TABLE
AS RETURN
(
	
	with ScheduleApportioned AS (
		SELECT S1.WBS_ID WBSID, S2.WBS_ID ApportionedToWBSId
		FROM DS04_schedule S1 INNER JOIN DS04_schedule S2 ON S1.EVT_J_to_task_ID = S2.task_ID
		WHERE 
			S1.upload_ID = @upload_ID 
		AND S2.upload_ID = @upload_ID
		AND S1.schedule_type = 'FC'
		AND S2.schedule_type = 'FC'
		AND S1.EVT_J_to_task_ID IS NOT NULL
	)
	
	SELECT 
		C.* 
	FROM 
		DS03_Cost C LEFT OUTER JOIN ScheduleApportioned S ON C.WBS_ID_WP = S.WBSID
	WHERE
			upload_ID = @upload_ID
		AND	EVT IN ('J','M')
		AND C.EVT_J_to_WBS_ID IS NOT NULL
		AND (
				TRIM(ISNULL(C.EVT_J_to_WBS_ID,'')) <> TRIM(ISNULL(S.ApportionedToWBSId,''))
			OR S.ApportionedToWBSId IS NULL -- If the WBS ID is NULL, then the task is not apportioned to anything.
		)
)
```
